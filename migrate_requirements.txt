"""Script pour migrer vers un requirements.txt optimisÃ©"""

import os
import sys

# Configuration minimale requise
MINIMAL_REQUIREMENTS = """# requirements.txt - Version minimale
streamlit>=1.28.0
azure-storage-blob>=12.19.0
azure-search-documents>=11.4.0
azure-core>=1.26.0
python-docx>=0.8.11
PyPDF2>=3.0.0
openpyxl>=3.1.0
pandas>=2.0.0
numpy>=1.24.0
plotly>=5.17.0
python-dotenv>=1.0.0
requests>=2.31.0
Pillow>=10.0.0
openai>=1.0.0
"""

# Configuration optimisÃ©e
OPTIMIZED_REQUIREMENTS = """# requirements.txt - Version optimisÃ©e
# Framework
streamlit>=1.28.0

# Azure (obligatoire)
azure-storage-blob>=12.19.0
azure-search-documents>=11.4.0
azure-core>=1.26.0
azure-identity>=1.14.0

# Documents
python-docx>=0.8.11
openpyxl>=3.1.0
PyPDF2>=3.0.0
reportlab>=4.0.0

# IA et LLM
openai>=1.0.0
# anthropic>=0.25.0         # DÃ©commentez si vous utilisez Claude
# google-generativeai>=0.5.0 # DÃ©commentez si vous utilisez Gemini
# mistralai>=0.0.8          # DÃ©commentez si vous utilisez Mistral

# DonnÃ©es
pandas>=2.0.0
numpy>=1.24.0
python-dateutil>=2.8.2

# Visualisation
plotly>=5.17.0
matplotlib>=3.7.0

# Utilitaires
python-dotenv>=1.0.0
requests>=2.31.0
beautifulsoup4>=4.12.0
Pillow>=10.0.0
aiofiles>=23.0.0

# SÃ©curitÃ©
cryptography>=41.0.0
"""

def backup_current():
    """Sauvegarde le requirements.txt actuel"""
    if os.path.exists('requirements.txt'):
        import shutil
        backup_name = 'requirements.txt.backup'
        counter = 1
        while os.path.exists(backup_name):
            backup_name = f'requirements.txt.backup.{counter}'
            counter += 1
        
        shutil.copy2('requirements.txt', backup_name)
        print(f"âœ… Sauvegarde crÃ©Ã©e : {backup_name}")
        return backup_name
    return None

def write_requirements(content, filename='requirements.txt'):
    """Ã‰crit le nouveau requirements.txt"""
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(content)
    print(f"âœ… {filename} crÃ©Ã© avec succÃ¨s")

def analyze_current():
    """Analyse le requirements.txt actuel"""
    if not os.path.exists('requirements.txt'):
        print("âŒ Aucun requirements.txt trouvÃ©")
        return None
    
    with open('requirements.txt', 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    packages = []
    stdlib_errors = []
    
    for line in lines:
        line = line.strip()
        if line and not line.startswith('#'):
            if line in ['datetime', 'asyncio', 'typing']:
                stdlib_errors.append(line)
            else:
                packages.append(line)
    
    return {
        'total_lines': len(lines),
        'packages': len(packages),
        'stdlib_errors': stdlib_errors,
        'has_azure': any('azure' in p for p in packages),
        'has_langchain': any('langchain' in p for p in packages),
        'has_tests': any(p.startswith(('pytest', 'black', 'flake8')) for p in packages)
    }

def main():
    print("ğŸ”§ Migration vers un requirements.txt optimisÃ©\n")
    
    # Analyser l'existant
    analysis = analyze_current()
    
    if analysis:
        print("ğŸ“Š Analyse du requirements.txt actuel:")
        print(f"  - Lignes totales : {analysis['total_lines']}")
        print(f"  - Packages : {analysis['packages']}")
        print(f"  - Azure prÃ©sent : {'âœ…' if analysis['has_azure'] else 'âŒ'}")
        
        if analysis['stdlib_errors']:
            print(f"\nâŒ Erreurs dÃ©tectÃ©es (modules Python standard):")
            for err in analysis['stdlib_errors']:
                print(f"  - {err}")
        
        if analysis['has_langchain']:
            print("\nğŸŸ¡ Langchain dÃ©tectÃ© (non utilisÃ© dans le code actuel)")
        
        if analysis['has_tests']:
            print("\nğŸŸ¡ Packages de test dÃ©tectÃ©s (pas nÃ©cessaires en production)")
    
    # Menu
    print("\nğŸš€ Choisissez une option:")
    print("1. Migration vers version MINIMALE (dÃ©marrage rapide)")
    print("2. Migration vers version OPTIMISÃ‰E (recommandÃ©e)")
    print("3. CrÃ©er les deux versions pour comparaison")
    print("4. Annuler")
    
    choice = input("\nVotre choix (1-4): ").strip()
    
    if choice == '4':
        print("âŒ Migration annulÃ©e")
        return
    
    # Backup
    backup = backup_current()
    
    # Migration
    if choice == '1':
        write_requirements(MINIMAL_REQUIREMENTS)
        print("\nâœ… Migration vers version minimale terminÃ©e!")
        print("ğŸ’¡ Testez avec: pip install -r requirements.txt")
        
    elif choice == '2':
        write_requirements(OPTIMIZED_REQUIREMENTS)
        print("\nâœ… Migration vers version optimisÃ©e terminÃ©e!")
        print("ğŸ’¡ N'oubliez pas de dÃ©commenter les APIs LLM que vous utilisez")
        
    elif choice == '3':
        write_requirements(MINIMAL_REQUIREMENTS, 'requirements_minimal.txt')
        write_requirements(OPTIMIZED_REQUIREMENTS, 'requirements_optimized.txt')
        print("\nâœ… Les deux versions ont Ã©tÃ© crÃ©Ã©es!")
        print("ğŸ’¡ Comparez et choisissez celle qui vous convient")
    
    if backup:
        print(f"\nğŸ’¾ Votre ancien fichier est sauvegardÃ© dans: {backup}")
    
    print("\nğŸ“ Prochaines Ã©tapes:")
    print("1. Testez localement: pip install -r requirements.txt")
    print("2. Committez et poussez vers Hugging Face")
    print("3. Surveillez les logs de build")

if __name__ == "__main__":
    main()